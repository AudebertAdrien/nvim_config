  image: node:22.9.0-alpine3.19

  stages:
    - build
    - test
    - deploy review
    - deploy staging
    - deploy production
    - production tests

  before_script:
    - apk update && apk add curl

  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/

  variables:
    STAGING_DOMAIN: www.youtube.com
    PRODUCTION_DOMAIN: www.google.com

  build_backend:
    stage: build
    script:
      - npm install
    artifacts:
      paths:
        - node_modules/

  run_tests:
    stage: test
    variables:
      NODE_ENV: test
    script:
      - npm test

#come back on gitlab when you can for this part
  deploy_review:
    stage: deploy review
    only:
      - merge_requests
    on_stop: stop review
    environment:
      name: review/$CI_COMMIT_REF_NAME 
      url: https://my-domain-$CI_ENVIRONMENT_SLUG.com
    script:
      - curl -s -o /dev/null -w "%{http_code}" https://$CI_ENVIRONMENT_SLUG

  stop_review:
    stage: deploy review
    when: manual  # Can also be set to automatic if desired
    only:
      - merged
      - closed
    environment:
      name: review/$CI_COMMIT_REF_NAME
      action: stop  # This stops the environment
    script:
      - echo "Stopping Preview Environment"
#======

  deploy_staging:
    stage: deploy staging
    environment:
      name: staging
      url: https://$STAGING_DOMAIN
    only:
      - master
    script:
      - curl -s -o /dev/null -w "%{http_code}" https://$STAGING_DOMAIN | grep 200

  deploy_production:
    stage: deploy production
    environment:
      name: production
      url: https://$PRODUCTION_DOMAIN 
    only:
      - master
    when: manual
    script:
      - curl -s -o /dev/null -w "%{http_code}"  https://$PRODUCTION_DOMAIN | grep 200

  production_test:
    stage: production tests
    when: on_success
    only:
      - master
    script:
      - curl -s -o /dev/null -w "%{http_code}" https://$PRODUCTION_DOMAIN | grep 200
