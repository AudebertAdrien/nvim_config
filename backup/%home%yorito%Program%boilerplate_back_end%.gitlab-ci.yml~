  image: node:22.9.0-alpine3.19

  stages:
    - test
    - deploy staging

  before_script:
    - apk update && apk add curl && apk add nodejs npm

  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/

  variables:
    NODE_ENV: test

  before_script:
    - npm ci

  run_tests:
    stage: test
    script:
      - npm test

  deploy_staging:
    stage: deploy production
    only:
      - main 
    script:
      - aws elasticbeanstalk create-environment \
        --application-name "my-app" \
        --environment-name "staging" \
        --version-label "v1" \
        --solution-stack-name "64bit Amazon Linux 2 v3.4.6 running Node.js 14"
